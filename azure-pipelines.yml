trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

name: $(Build.BuildId)

variables:
- group: 'EA ECR-PUSH SHARED'
- name: 'k8s-service-connection'
  value: 'enterprisearchitecture-pnpbj-k8s'
- name: 'kubernetes-namespace'
  value: 'enterprisearchitecture-pnpbj'

steps:
- task: Docker@2
  name: BuildMigrate
  displayName: 'Build migrate docker image'
  inputs:
    command: 'build'
    Dockerfile: 'backend/Dockerfile.migrate'
    buildContext: 'backend'
    arguments: '--tag easi-migrate:$(Build.BuildNumber)'
    addPipelineData: false

- task: Docker@2
  name: BuildBackend
  displayName: 'Build backend docker image'
  inputs:
    command: 'build'
    Dockerfile: 'backend/Dockerfile'
    buildContext: 'backend'
    arguments: '--tag easi-backend:$(Build.BuildNumber)'
    addPipelineData: false

- task: Docker@2
  name: BuildFrontend
  displayName: 'Build frontend docker image'
  inputs:
    command: 'build'
    Dockerfile: 'frontend/Dockerfile'
    buildContext: 'frontend'
    arguments: '--tag easi-frontend:$(Build.BuildNumber)'
    addPipelineData: false

- task: ECRPushImage@1
  name: PushMigrate
  displayName: 'Push migrate image to AWS'
  condition: succeeded()
  inputs:
    awsCredentials: 'Shared-Prod ECR-Push'
    regionName: 'eu-central-1'
    imageSource: 'imagename'
    sourceImageName: 'easi-migrate'
    sourceImageTag: '$(Build.BuildNumber)'
    repositoryName: 'architecture/easi-migrate'
    pushTag: '$(Build.BuildNumber)'

- task: ECRPushImage@1
  name: PushBackend
  displayName: 'Push backend image to AWS'
  condition: succeeded()
  inputs:
    awsCredentials: 'Shared-Prod ECR-Push'
    regionName: 'eu-central-1'
    imageSource: 'imagename'
    sourceImageName: 'easi-backend'
    sourceImageTag: '$(Build.BuildNumber)'
    repositoryName: 'architecture/easi-backend'
    pushTag: '$(Build.BuildNumber)' 

- task: ECRPushImage@1
  name: PushFrontend
  displayName: 'Push frontend image to AWS'
  condition: succeeded()
  inputs:
    awsCredentials: 'Shared-Prod ECR-Push'
    regionName: 'eu-central-1'
    imageSource: 'imagename'
    sourceImageName: 'easi-frontend'
    sourceImageTag: '$(Build.BuildNumber)'
    repositoryName: 'architecture/easi-frontend'
    pushTag: '$(Build.BuildNumber)' 
    
- task: replacetokens@5
  name: ReplaceTokens
  displayName: 'replace tokens in k8s manifests'
  condition: succeeded()
  inputs:
    targetFiles: '$(Build.SourcesDirectory)/k8s/*.yaml'
    encoding: 'auto'
    tokenPattern: 'azpipelines'
    writeBOM: true
    actionOnMissing: 'warn'
    keepToken: false
    actionOnNoFiles: 'fail'
    enableTransforms: false
    enableRecursion: false
    useLegacyPattern: false
    enableTelemetry: false
    
- task: Kubernetes@1
  name: ApplyMigrateJob
  displayName: 'Run database migrations'
  condition: succeeded()
  inputs:
    connectionType: Kubernetes Service Connection
    kubernetesServiceEndpoint: '$(k8s-service-connection)'
    namespace: '$(kubernetes-namespace)'
    command: apply
    arguments: '-f $(Build.SourcesDirectory)/k8s/migrate-job.yaml'
    versionSpec: 1.22.9

- task: Kubernetes@1
  name: WaitForMigration
  displayName: 'Wait for migration to complete'
  condition: succeeded()
  inputs:
    connectionType: Kubernetes Service Connection
    kubernetesServiceEndpoint: '$(k8s-service-connection)'
    namespace: '$(kubernetes-namespace)'
    command: custom
    arguments: 'wait --for=condition=complete --timeout=300s job/easi-migrate-$(Build.BuildNumber)'
    versionSpec: 1.22.9

- task: Kubernetes@1
  name: ApplyManifests
  displayName: 'Apply backend and frontend manifests'
  condition: succeeded()
  inputs:
    connectionType: Kubernetes Service Connection
    kubernetesServiceEndpoint: '$(k8s-service-connection)'
    namespace: '$(kubernetes-namespace)'
    command: apply
    arguments: '-f $(Build.SourcesDirectory)/k8s/backend-deployment.yaml -f $(Build.SourcesDirectory)/k8s/backend-service.yaml -f $(Build.SourcesDirectory)/k8s/frontend-deployment.yaml -f $(Build.SourcesDirectory)/k8s/frontend-service.yaml -f $(Build.SourcesDirectory)/k8s/ingress.yaml'
    versionSpec: 1.22.9
